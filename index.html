<script>
/* ====== State ====== */
let numDecks = 6;
let runningCount = 0;
let seenCards = [];
let burnedCards = [];
let dealer = { up: null, hole: null, draws: [] };
let hands = [];
let activeHandIndex = 0;
let roundCount = 0;

let bankroll = Number(localStorage.getItem('bj_bankroll')) || 1000;
let minBet = Number(localStorage.getItem('bj_minBet')) || 10;
let spreadMap = parseSpread(localStorage.getItem('bj_spread') || '0:1,1:2,2:4,3:8,4:12');

let wins = Number(localStorage.getItem('bj_wins')) || 0;
let losses = Number(localStorage.getItem('bj_losses')) || 0;
let pushes = Number(localStorage.getItem('bj_pushes')) || 0;

/* ====== Hi-Lo values ====== */
const hiLoValues = { '2':1,'3':1,'4':1,'5':1,'6':1,'7':0,'8':0,'9':0,'10':-1,'J':-1,'Q':-1,'K':-1,'A':-1 };

/* ====== Helpers ====== */
function normalizeCardToken(tok){
  if(!tok) return null;
  tok = String(tok).trim().toUpperCase();
  if(tok==='T') tok='10';
  if(tok.length>2 && tok.includes(',')) tok = tok.split(',')[0];
  if(tok.match(/^[2-9]|10|A|J|Q|K$/)) return tok;
  tok = tok.replace(/[^0-9AJQK]/g,'').toUpperCase();
  if(tok==='') return null;
  return tok;
}
function cardValue(card){ if(card==='A') return 11; if(['J','Q','K'].includes(card)) return 10; return parseInt(card);}
function handTotal(cards){
  let total=0, aces=0;
  for(let c of cards){ if(c==='A') aces++; else total+=cardValue(c);}
  for(let i=0;i<aces;i++){ total += (total+11<=21)?11:1;}
  return total;
}
function isSoft(cards){ return cards.includes('A') && handTotal(cards)-11 <=10; }
function parseSpread(txt){ return txt? txt.split(',').map(s=>{ let [k,v]=s.split(':').map(x=>x.trim()); return [Number(k),Number(v)]; }).sort((a,b)=>a[0]-b[0]):[[0,1]];}
function getTrueCount(){
  const totalCards=numDecks*52;
  const remaining=Math.max(totalCards-seenCards.length,1);
  let remDecks=remaining/52;
  if(remDecks<0.0625) remDecks=0.0625;
  document.getElementById('remDecks').innerText = remDecks.toFixed(2);
  return runningCount/remDecks;
}
function logAction(s){
  const el=document.getElementById('actionLog');
  el.innerHTML = new Date().toLocaleTimeString()+' â€” '+s+'<br>'+el.innerHTML;
}
function updateCountWithCard(card){
  const c = normalizeCardToken(card); if(!c) return;
  seenCards.push(c);
  if(hiLoValues.hasOwnProperty(c)) runningCount+=hiLoValues[c];
  updateDisplay();
}
function updateDisplay(){
  document.getElementById('displayDecks').innerText=numDecks;
  document.getElementById('runningCount').innerText=runningCount;
  const tc=getTrueCount();
  document.getElementById('trueCount').innerText=tc.toFixed(2);
  document.getElementById('displayBankroll').innerText=bankroll.toFixed(2);
  document.getElementById('displayMinBet').innerText=minBet;
  document.getElementById('displayPlaced').innerText=totalPlacedBets();
  document.getElementById('displaySuggested').innerText=suggestedBet();
  document.getElementById('roundCount').innerText=roundCount;
  const dealerCardsEl=document.getElementById('dealerCards'); dealerCardsEl.innerHTML='';
  if(dealer.up) dealerCardsEl.appendChild(createCardEl(dealer.up));
  if(dealer.hole) dealerCardsEl.appendChild(createCardEl('ðŸ‚ '));
  for(let d of dealer.draws) dealerCardsEl.appendChild(createCardEl(d));
  document.getElementById('dealerStatus').innerText = `Dealer up: ${dealer.up||'-'} â€¢ hole: ${dealer.hole?'set':'-'} â€¢ draws: ${dealer.draws.join(',')||'-'}`;
  renderHands();
  document.getElementById('seenList').innerText=seenCards.join(' , ');
  const dot=document.getElementById('countDot'); dot.className='countdot '+(Math.abs(runningCount)>0?'green':'red');
  localStorage.setItem('bj_bankroll',bankroll);
  localStorage.setItem('bj_minBet',minBet);
  localStorage.setItem('bj_spread',document.getElementById('spreadMap').value);
  localStorage.setItem('bj_wins',wins);
  localStorage.setItem('bj_losses',losses);
  localStorage.setItem('bj_pushes',pushes);
  document.getElementById('wins').innerText=wins;
  document.getElementById('losses').innerText=losses;
  document.getElementById('pushes').innerText=pushes;
  updateRecommendation();
}

/* ====== UI ====== */
function createCardEl(card){ const div=document.createElement('div'); div.className='card'; div.innerText=card; return div; }
function renderHands(){
  const container=document.getElementById('playerHands'); container.innerHTML='';
  hands.forEach((h,i)=>{
    const wrapper=document.createElement('div');
    wrapper.style.border=i===activeHandIndex?'2px solid var(--accent)':'1px solid #06332d';
    wrapper.style.padding='8px'; wrapper.style.borderRadius='8px'; wrapper.style.marginTop='8px';
    const title=document.createElement('div'); title.className='muted';
    title.innerText=`Hand ${i+1} ${h.splitFrom?'(split)':''} ${h.finished?'â€¢ Finished':''}`;
    wrapper.appendChild(title);
    const cardsEl=document.createElement('div'); cardsEl.className='cards';
    h.cards.forEach(c=>cardsEl.appendChild(createCardEl(c)));
    wrapper.appendChild(cardsEl);
    const total=document.createElement('div'); total.className='muted';
    total.innerText=`Total: ${handTotal(h.cards)} ${isSoft(h.cards)?'(Soft)':''}`;
    wrapper.appendChild(total);
    const betLine=document.createElement('div'); betLine.className='muted';
    betLine.innerHTML=`Placed Bet: $${h.placedBet.toFixed(2)} ${h.doubled?' â€¢ DOUBLED':''}`;
    wrapper.appendChild(betLine);
    const btns=document.createElement('div'); btns.style.marginTop='8px';
    const selBtn=document.createElement('button'); selBtn.className='smallbtn'; selBtn.innerText='Select';
    selBtn.onclick=()=>{ activeHandIndex=i; updateDisplay(); }; btns.appendChild(selBtn);
    const hitBtn=document.createElement('button'); hitBtn.className='smallbtn'; hitBtn.innerText='Hit'; hitBtn.onclick=()=>{ promptAddToHand(i); }; btns.appendChild(hitBtn);
    const dblBtn=document.createElement('button'); dblBtn.className='smallbtn'; dblBtn.innerText='Double'; dblBtn.onclick=()=>{ doDouble(i); }; btns.appendChild(dblBtn);
    const finBtn=document.createElement('button'); finBtn.className='smallbtn'; finBtn.innerText='Finish'; finBtn.onclick=()=>{ hands[i].finished=true; updateDisplay(); }; btns.appendChild(finBtn);
    const betBtn=document.createElement('button'); betBtn.className='smallbtn'; betBtn.innerText='Bet'; betBtn.onclick=()=>{ placeBet(i); }; btns.appendChild(betBtn);
    wrapper.appendChild(btns);
    container.appendChild(wrapper);
  });
}

/* ====== Actions ====== */
function placeBet(idx){ 
  idx=idx||activeHandIndex;
  const betInput=prompt("Enter bet amount for this hand (min $"+minBet+")");
  const bet=Number(betInput); 
  if(isNaN(bet)||bet<minBet){ alert("Invalid bet"); return; }
  hands[idx].placedBet=bet;
  logAction("Placed bet $"+bet.toFixed(2)+" on Hand "+(idx+1));
  updateDisplay();
}

function addCard(){ 
  const raw=document.getElementById('addCard').value.trim(); if(!raw) return;
  const card=normalizeCardToken(raw.startsWith('P')?raw.slice(1):raw); if(!card) return;
  hands[activeHandIndex].cards.push(card); updateCountWithCard(card);
  document.getElementById('addCard').value=''; logAction(`Player (hand ${activeHandIndex+1}) received ${card}`);
  updateDisplay();
}

function promptAddToHand(idx){ 
  const card=prompt('Enter card to give to hand '+(idx+1)+' (e.g. 3, 10, A, K)'); if(!card) return;
  const c=normalizeCardToken(card); if(!c) return;
  hands[idx].cards.push(c); updateCountWithCard(c); logAction(`Player (hand ${idx+1}) received ${c}`); updateDisplay();
}

function recordWin(idx){ 
  idx=idx||activeHandIndex; 
  const hand=hands[idx]; 
  const payout=hand.placedBet*(hand.doubled?2:1); 
  bankroll+=payout; wins++; logAction(`Hand won +$${payout.toFixed(2)}`); updateDisplay();
}
function recordLoss(idx){ 
  idx=idx||activeHandIndex; 
  const hand=hands[idx]; 
  const loss=hand.placedBet*(hand.doubled?2:1); 
  bankroll-=loss; losses++; logAction(`Hand lost -$${loss.toFixed(2)}`); updateDisplay();
}
function recordPush(idx){ idx=idx||activeHandIndex; pushes++; logAction("Hand push"); updateDisplay(); }

/* ====== Probability ====== */
function estimateWinProbability(handCards, dealerUp, simulations=1000){
  let wins=0;
  for(let i=0;i<simulations;i++){
    let playerTotal=handTotal(handCards);
    let dealerTotal=simulateDealer(dealerUp);
    if(playerTotal>21) continue;
    if(dealerTotal>21 || playerTotal>dealerTotal) wins++;
    else if(playerTotal===dealerTotal) wins+=0.5;
  }
  return (wins/simulations*100).toFixed(1);
}
function simulateDealer(upcard){
  const cards=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
  let draws=[upcard]; let total=cardValue(upcard);
  while(total<17){ 
    const draw=cards[Math.floor(Math.random()*cards.length)]; draws.push(draw); total=handTotal(draws);
  }
  return total;
}
function updateRecommendation(){
  if(hands.length===0) return;
  const hand=hands[activeHandIndex];
  const move=handTotal(hand.cards)>=17?'Stand':'Hit'; 
  const winProb=estimateWinProbability(hand.cards,dealer.up||'6');
  document.getElementById('recommendation').innerText=`Move: ${move} â€¢ Win%: ${winProb}%`;
}

/* ====== Betting helpers ====== */
function suggestedBet(){
  const tc=Math.floor(getTrueCount());
  let chosen=1;
  for(const [thr,mul] of spreadMap) if(tc>=thr) chosen=mul;
  return Math.max(minBet, Math.round(minBet*chosen*100)/100);
}
function totalPlacedBets(){ return hands.reduce((s,h)=>s+(h.placedBet||0),0).toFixed(2); }

/* ====== Init ====== */
function resetStateHands(){ hands=[{cards:[],doubled:false,splitFrom:null,placedBet:0,finished:false}]; activeHandIndex=0; updateDisplay();}
function init(){ document.getElementById('bankroll').value=bankroll; document.getElementById('minBet').value=minBet;
document.getElementById('spreadMap').value=localStorage.getItem('bj_spread')||document.getElementById('spreadMap').value;
spreadMap=parseSpread(document.getElementById('spreadMap').value); resetStateHands(); updateDisplay();}
init();
</script>
